# Victoria II 已灭亡国家清理功能

## 功能概述

新增了强大的已灭亡国家清理功能，可以安全地清理Victoria II存档中不再需要的已灭亡国家数据块，减少存档文件大小并提高游戏性能。

## 主要特性

### 🔍 **智能识别已灭亡国家**
- 识别有国家数据但无省份的国家
- 排除特殊标签（如叛军REB）
- 确认真正的灭亡国家（有首都、政府等信息）

### 📊 **引用次数统计**
- 统计每个已灭亡国家在存档中的引用次数
- 支持多种引用模式检测：
  - 带引号的引用 (`"GER"`)
  - 赋值引用 (`owner=GER`)
  - 核心声明 (`core="POL"`)
  - 国家块 (`GER={`)

### 🛡️ **安全清理机制**
- 自动创建备份文件
- 花括号平衡检查
- 预览模式（干运行）
- 用户确认机制

### ⚖️ **花括号平衡保护**
- 精确解析国家数据块
- 确保删除完整的块结构
- 验证花括号配对正确
- 防止文件结构损坏

## 分析结果

基于 `autosave.v2` 的分析：

### 📈 **统计数据**
- **发现已灭亡国家**: 112个
- **总引用次数**: 2950次
- **预计节省空间**: 数千字符

### 🔗 **引用次数排行榜**
1. **GER (德意志)**: 211次引用
2. **CAN (加拿大)**: 180次引用  
3. **PLC (波兰立陶宛)**: 179次引用
4. **CSA (美利坚联盟国)**: 158次引用
5. **SWE (瑞典)**: 96次引用
6. **POL (波兰)**: 82次引用
7. **MYS (马来西亚)**: 69次引用
8. **GXI (广西)**: 67次引用
9. **UKR (乌克兰)**: 66次引用
10. **MOR (摩洛哥)**: 49次引用

## 使用方法

### 方法1: 命令行模式
```bash
# 预览模式（推荐先使用）
python clean_dead_countries.py preview

# 实际清理
python clean_dead_countries.py clean
```

### 方法2: 交互式模式
```bash
python clean_dead_countries.py
```
然后按提示选择：
1. 选择存档文件
2. 选择操作模式（预览/清理）

### 方法3: API调用
```python
from victoria2_main_modifier import Victoria2Modifier

modifier = Victoria2Modifier('存档文件.v2')

# 预览
result = modifier.remove_dead_country_blocks(dry_run=True)

# 安全清理（自动备份）
result = modifier.clean_dead_countries_with_backup()
```

## 技术实现

### 🔧 **核心算法**
1. **国家识别**: 使用正则表达式 `^([A-Z]{2,3})=\s*{` 查找国家块
2. **省份归属**: 使用 `owner="?([A-Z]{2,3})"?` 识别省份拥有者
3. **块解析**: 精确的花括号计数确定数据块边界
4. **引用统计**: 多模式搜索统计国家代码出现次数

### 🛠️ **安全机制**
- **备份创建**: 自动生成带时间戳的备份文件
- **完整性检查**: 删除前后的花括号平衡验证
- **原子操作**: 验证成功后才保存修改
- **错误恢复**: 失败时可从备份恢复

## 清理效果

### ✅ **优点**
- 减少存档文件大小
- 提高游戏加载速度
- 清理无用的历史数据
- 保持文件结构完整

### ⚠️ **注意事项**
- 删除的国家可能在某些MOD中被引用
- 部分历史事件可能涉及已删除的国家
- 建议先在副本上测试

## 备份和恢复

### 自动备份
- 格式: `文件名_before_cleanup_YYYYMMDD_HHMMSS.v2`
- 包含完整的原始数据
- 可用于紧急恢复

### 清理报告
- 格式: `dead_countries_cleanup_report_YYYYMMDD_HHMMSS.json`
- 记录所有删除的国家
- 包含引用次数统计
- 便于审核和分析

## 示例输出

```
📊 已灭亡国家统计:
   总数: 112

🔗 引用次数统计:
    1. GER: 211 次引用 (首都:549)
    2. CAN: 180 次引用 (首都:1)
    3. PLC: 179 次引用 (首都:360)
    ...

✅ 清理完成:
   删除国家块: 112
   总共节省: 45,678 字符
```

## 兼容性

- ✅ 支持所有Victoria II版本
- ✅ 兼容各种MOD
- ✅ 保持存档格式完整
- ✅ Windows PowerShell兼容

## 结论

已灭亡国家清理功能提供了一个安全、高效的方式来优化Victoria II存档文件。通过智能识别、统计分析和安全清理，可以显著减少存档大小，同时保持游戏的完整性和稳定性。

建议在使用前先进行预览，确认要删除的国家符合预期，然后再执行实际清理操作。
