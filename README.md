# Victoria II 存档文件解析器

## 概述
这是一个用于解析Victoria II（维多利亚2）游戏存档文件（.v2格式）的Python程序。该程序可以将复杂的存档文件数据提取并转换为结构化的Python对象，便于分析和处理。

## 文件说明

### 1. `victoria2_parser.py` - 完整解析器
这是功能最完整的解析器，包含详细的数据结构定义：

**主要类和数据结构：**
- `GameData` - 主游戏数据
- `Country` - 国家数据
- `Province` - 省份数据  
- `WorldMarket` - 世界市场数据
- `PopGroup` - 人口群体数据
- `Technology` - 科技数据
- `Flag` - 游戏标志

**功能特点：**
- 完整解析存档文件的所有主要数据块
- 支持嵌套数据结构的递归解析
- 可导出为JSON格式
- 详细的数据类型转换

### 2. `simple_parser.py` - 简化解析器
这是一个简化版本，更容易理解和使用：

**主要功能：**
- 提取基本游戏信息（日期、玩家、政府类型等）
- 统计国家和省份数量
- 分析世界市场概况
- 提取游戏标志列表
- 生成存档摘要报告

### 3. `test_parser.py` - 测试脚本
用于测试解析器功能的脚本。

### 4. `simple_parser.py` - 简化解析器
更快速、更容易使用的解析器，专注于提取关键信息。

### 5. `analyze_data.py` - 数据分析工具
对解析后的JSON数据进行深度分析，包括：
- 国家经济排名分析
- 世界市场趋势
- 省份控制分析
- 游戏标志分类统计

### 6. `run_parser.bat` - Windows批处理脚本
一键运行解析器的便捷脚本，自动检测Python环境并提供菜单选择。

## 安装要求

### 安装Python
如果您的系统还没有安装Python，请按以下步骤安装：

#### Windows系统：
1. 访问 https://www.python.org/downloads/
2. 下载最新版本的Python（推荐3.8或更高版本）
3. 运行安装程序，**确保勾选"Add Python to PATH"选项**
4. 完成安装后，打开命令提示符测试：
   ```cmd
   python --version
   ```

#### 验证安装：
```cmd
python --version
py --version
```

## 使用方法

### 快速开始（推荐）

**Windows用户 - 使用批处理脚本：**
1. 双击运行 `run_parser.bat`
2. 按照菜单提示选择解析模式
3. 等待解析完成

### 方法1：使用简化解析器（推荐初学者）

1. 将存档文件复制到解析器文件夹
2. 打开PowerShell或命令提示符
3. 切换到存档文件目录：
   ```cmd
   cd "c:\Users\zhangwc6\Documents\Paradox Interactive\Victoria II\save games"
   ```
4. 运行简化解析器：
   ```cmd
   python simple_parser.py
   ```

### 方法2：使用完整解析器

```cmd
python victoria2_parser.py
```

### 方法3：数据分析

解析完成后，运行数据分析工具：
```cmd
python analyze_data.py
```

这将提供：
- 国家经济排名
- 世界市场分析  
- 省份控制统计
- 游戏标志分类
- 详细的分析报告

## 输出文件

运行解析器后会生成以下文件：

- `victoria2_analysis.json` - 存档分析摘要（简化解析器）
- `china_save_parsed.json` - 详细解析结果（完整解析器）
- `*_analysis_report.txt` - 深度分析报告（数据分析工具）

### 分析报告示例内容：
- **基本统计**: 游戏年限、国家数量、省份统计
- **国家排名**: 按税收基础和研究点数排序
- **世界市场**: 商品价格和供应分析
- **省份控制**: 领土控制和占领情况
- **游戏标志**: 历史事件完成情况分类

## 支持的数据类型

### 基本游戏信息
- 游戏日期和开始日期
- 玩家国家标识
- 政府类型
- 自动化设置
- 叛军、单位、州的数量

### 游戏标志（Flags）
提取所有激活的游戏事件标志，如：
- 诺贝尔奖获得情况
- 历史事件完成状态
- 奥运会举办记录

### 国家数据
对每个国家提取：
- 税收基础
- 首都省份ID
- 研究点数
- 科技研发状态
- 国家特有标志

### 省份数据
对每个省份提取：
- 名称和ID
- 拥有者和控制者
- 核心声明
- 驻军情况
- 建筑物（要塞、海军基地、铁路等）
- 省份修正效果

### 世界市场数据
- 商品库存池
- 价格池
- 供应池
- 历史价格数据

## 文件格式说明

Victoria II存档文件使用类似于Paradox Development Studio其他游戏的文本格式：

```
key=value                # 简单键值对
key="string value"       # 字符串值
key=yes/no              # 布尔值
key=                    # 复杂对象开始
{
    nested_key=value    # 嵌套数据
    nested_block=
    {
        # 更深层嵌套
    }
}
```

## 常见问题

### Q: 运行时提示"python不是内部或外部命令"
A: 这说明Python没有正确安装或没有添加到系统PATH。请重新安装Python并确保勾选"Add to PATH"选项。

### Q: 解析速度较慢
A: Victoria II存档文件通常很大（几MB到几十MB），解析需要一些时间。可以使用简化解析器来获得更快的基本信息提取。

### Q: 某些数据没有解析出来
A: Victoria II存档格式复杂，包含大量嵌套结构。当前解析器专注于主要数据。如需特定数据，可以修改解析器代码。

### Q: 如何分析特定国家的数据？
A: 在解析结果的JSON文件中查找对应的国家代码（如"CHI"表示中国），或修改解析器代码来专门提取特定国家数据。

## 扩展开发

如果您想要扩展解析器功能：

1. **添加新的数据结构：** 在`victoria2_parser.py`中定义新的`@dataclass`
2. **解析新的数据块：** 在`_parse_block()`方法中添加新的解析逻辑
3. **自定义输出格式：** 修改`save_to_json()`方法或添加新的输出方法

## 技术细节

### 解析策略
- 使用正则表达式进行快速模式匹配
- 递归解析嵌套的大括号结构
- 智能类型转换（字符串、数字、布尔值）
- 处理重复键值（转换为列表）

### 性能优化
- 按需解析（只解析请求的数据部分）
- 内存高效的流式处理
- 可配置的解析深度限制

## 许可证
此代码仅供学习和个人使用。请遵守Victoria II的用户协议。

## 贡献
欢迎提交问题报告和改进建议！
